#!/bin/bash
export PATH="/home/hnc/.local/bin:$PATH"
echo "mtpatchdock [receptor+mini complex pdb] "
if [ ${#} -eq 0 ] ; then
       echo "mtpatchdock [receptor+mini complex pdb] "
       exit 1
fi
if [ ${#} -eq 2 ] ; then
       exit 1
fi

grep ATOM $1 | grep " X "  >mini.pdb
grep ATOM $1 | grep -v " X " >receptor.pdb
pydssp -d cuda mini.pdb | awk '{print $1}' > ss
number_ss=`cat ss | tr -d "-" | wc -m`
total_number=`cat ss | wc -m`
ss_ratio=`echo "$number_ss / $total_number" | bc -l`

pdb_tofasta mini.pdb | grep -v '>' | sed ':a;N;$!ba;s/\n//g' > fasta

rm mt.fasta
for f in $(seq 1 1000)
do
       echo ">${f}_mt" >>mt.fasta
       mtgen   >> mt.fasta
done
echo "1000 mutant sequences were generated"
efold mt.fasta | tee ef.log

echo "1000 pdbs were generated by esmfold"
echo "==================================="

grep "Predicted structure" ef.log | awk '{print $16 "  " $11 ".pdb"}' > efold.result

for h in $(seq 1 1000)
do
	line=`head -$h efold.result | tail -1`
	pLDDT=`echo $line | awk -F ',' '{print $1}'`
	mininame=`echo $line | awk -F ',' '{print $2}'` 
        if   [[ `echo "$pLDDT < 80.0" | bc` -eq 1 ]] ; then
		rm $mininame
	fi
done
ls *_mt.pdb > pdblist

for g in $(sed -n '=' pdblist)
do
	mininame=`head -$g pdblist | tail -1`
	echo $mininame
        pydssp -d cpu $mininame | awk '{print $1}' > ss_temp 
        g_total_number=`cat ss_temp | wc -m`
        g_ss=`cat ss_temp | tr -d "-" | wc -m`
	g_ss_ratio=$( echo "$g_ss; $g_total_number" | awk '{printf "%f", $1 / $2 }' )
        echo $ss_ratio
        echo $g_ss_ratio
       if   [[ `echo "$g_ss_ratio < $ss_ratio" | bc -l` -eq 1 ]] ; then
	rm $mininame
	echo "$mininame is removed."
       fi
done

ls *_mt.pdb > mtminilist

mkdir mtpdbs

patchdockmt20 receptor.pdb

echo "Mutation Round was done!"
